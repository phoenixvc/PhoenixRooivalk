name: Documentation Link Checker

on:
  pull_request:
    paths:
      - "apps/docs/**"
      - ".github/workflows/docs-link-checker.yml"
  push:
    branches: [main]
    paths:
      - "apps/docs/**"
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  check-links:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        working-directory: apps/docs
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for broken links
        id: link-check
        run: |
          # Run build and capture output to a file for analysis
          BUILD_LOG_FILE=$(mktemp)
          set +e  # Don't exit on error immediately
          pnpm run build 2>&1 | tee "$BUILD_LOG_FILE"
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          # Check for Docusaurus broken link warnings
          BROKEN_LINKS=""
          if grep -q "Docusaurus found broken links" "$BUILD_LOG_FILE"; then
            echo "has_broken_links=true" >> $GITHUB_OUTPUT
            
            # Extract and format broken links
            BROKEN_LINKS=$(grep -A 100 "Exhaustive list of all broken links found" "$BUILD_LOG_FILE" | \
              grep -E "^- |source page path" | head -50)
            
            echo "## âŒ Broken Links Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following broken links were found during the documentation build:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            grep -A 100 "Exhaustive list of all broken links found" "$BUILD_LOG_FILE" | head -60 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Save broken links to output for PR comment
            {
              echo "broken_links<<EOF"
              grep -A 100 "Exhaustive list of all broken links found" "$BUILD_LOG_FILE" | head -60
              echo "EOF"
            } >> $GITHUB_OUTPUT
            
            rm "$BUILD_LOG_FILE"
            exit 1
          else
            echo "has_broken_links=false" >> $GITHUB_OUTPUT
            echo "## âœ… No Broken Links Found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All documentation links are valid." >> $GITHUB_STEP_SUMMARY
            rm "$BUILD_LOG_FILE"
            
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "Build failed for other reasons"
              exit $BUILD_EXIT_CODE
            fi
          fi
        env:
          NODE_ENV: production

      - name: Comment on PR with broken links
        if: failure() && github.event_name == 'pull_request' && steps.link-check.outputs.has_broken_links == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const brokenLinks = `${{ steps.link-check.outputs.broken_links }}`;
            const body = `## ðŸ”— Documentation Link Check Failed

            The following broken links were detected in the documentation:

            \`\`\`
            ${brokenLinks}
            \`\`\`

            ### How to fix:
            1. **Run locally**: \`pnpm -C apps/docs run check-links\` to identify broken links
            2. **Check file paths**: Ensure referenced files exist and paths are correct
            3. **Use relative paths**: Use \`./filename\` or \`../folder/filename\` without \`.md\` extension
            4. **Check for typos**: Verify document IDs match frontmatter \`id\` fields

            ### Common issues:
            - Missing or renamed files
            - Incorrect relative path depth (\`../\` vs \`./\`)
            - Using \`.md\` extension in links (Docusaurus strips these)
            - Case sensitivity in file paths`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Markdown lint check
        run: pnpm run lint
        continue-on-error: true

      - name: Report summary tips
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Tips for Documentation Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Local check**: Run \`pnpm -C apps/docs run check-links\` before committing" >> $GITHUB_STEP_SUMMARY
          echo "- **Relative paths**: Use \`./filename\` or \`../folder/filename\` (no \`.md\` extension)" >> $GITHUB_STEP_SUMMARY
          echo "- **Document IDs**: Use kebab-case for all document IDs and filenames" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontmatter**: Ensure \`id\` field matches the filename (without extension)" >> $GITHUB_STEP_SUMMARY
