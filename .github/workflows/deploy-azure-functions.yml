name: Deploy Azure Functions

on:
  push:
    branches: [main]
    paths:
      - "apps/docs/azure-functions/**"
      - ".github/workflows/deploy-azure-functions.yml"
  pull_request:
    paths:
      - "apps/docs/azure-functions/**"
      - ".github/workflows/deploy-azure-functions.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        type: choice
        options:
          - development
          - staging
          - production
        default: development

# Restrict permissions at workflow level
permissions:
  contents: read
  actions: read

env:
  NODE_VERSION: "20"
  AZURE_FUNCTIONAPP_PACKAGE_PATH: "apps/docs/azure-functions"

jobs:
  # ===========================================
  # Infrastructure Validation (Early Failure)
  # ===========================================
  validate-infrastructure:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      can_deploy: ${{ steps.check.outputs.can_deploy }}
      missing_secrets: ${{ steps.check.outputs.missing_secrets }}
      missing_vars: ${{ steps.check.outputs.missing_vars }}
    steps:
      - name: Check Required Secrets
        id: check
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” Validating Azure Infrastructure Prerequisites"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âš ï¸  IMPORTANT: This workflow requires Azure infrastructure to be deployed first."
          echo ""
          echo "If this is your first deployment, you must:"
          echo "  1ï¸âƒ£  Deploy infrastructure: Run 'deploy-infrastructure.yml' workflow"
          echo "  2ï¸âƒ£  Wait for secrets to be populated automatically"
          echo "  3ï¸âƒ£  Then run this workflow to deploy the Functions app"
          echo ""
          echo "See .github/DEPLOYMENT_SEQUENCE.md for detailed instructions."
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          MISSING_SECRETS=""
          PRESENT_SECRETS=""
          MISSING_VARS=""
          CONFIGURED_SECRETS=""
          CONFIGURED_VARS=""
          CAN_DEPLOY="true"

          # Required secrets for Azure Functions deployment
          echo "Checking required secrets..."
          echo "ðŸ” Debug: Checking AZURE_FUNCTIONAPP_PUBLISH_PROFILE..."
          echo "  Secret is set (boolean): ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE != '' }}"

          if [ -z "${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}" ]; then
            echo "::error::AZURE_FUNCTIONAPP_PUBLISH_PROFILE is NOT set or is EMPTY"
            echo "::error::This secret must contain the publish profile XML from Azure"
            echo "::error::To fix: Download publish profile from Azure Portal and set as secret"
            MISSING_SECRETS="${MISSING_SECRETS}AZURE_FUNCTIONAPP_PUBLISH_PROFILE, "
            CAN_DEPLOY="false"
          else
            echo "âœ… AZURE_FUNCTIONAPP_PUBLISH_PROFILE is configured"
            CONFIGURED_SECRETS="${CONFIGURED_SECRETS}AZURE_FUNCTIONAPP_PUBLISH_PROFILE, "
            PRESENT_SECRETS="${PRESENT_SECRETS}AZURE_FUNCTIONAPP_PUBLISH_PROFILE, "
          fi

          if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}AZURE_CREDENTIALS, "
            # Not blocking - publish profile is sufficient
          else
            CONFIGURED_SECRETS="${CONFIGURED_SECRETS}AZURE_CREDENTIALS, "
            PRESENT_SECRETS="${PRESENT_SECRETS}AZURE_CREDENTIALS, "
          fi

          # Required for Cosmos DB
          if [ -z "${{ secrets.COSMOS_DB_CONNECTION_STRING }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}COSMOS_DB_CONNECTION_STRING, "
            CAN_DEPLOY="false"
          else
            CONFIGURED_SECRETS="${CONFIGURED_SECRETS}COSMOS_DB_CONNECTION_STRING, "
            PRESENT_SECRETS="${PRESENT_SECRETS}COSMOS_DB_CONNECTION_STRING, "
          fi

          # Required for Azure OpenAI - check both options
          if [ -n "${{ secrets.AZURE_AI_ENDPOINT }}" ]; then
            PRESENT_SECRETS="${PRESENT_SECRETS}AZURE_AI_ENDPOINT, "
            CONFIGURED_SECRETS="${CONFIGURED_SECRETS}AZURE_AI_ENDPOINT, "
          elif [ -n "${{ secrets.AZURE_OPENAI_ENDPOINT }}" ]; then
            PRESENT_SECRETS="${PRESENT_SECRETS}AZURE_OPENAI_ENDPOINT, "
            CONFIGURED_SECRETS="${CONFIGURED_SECRETS}AZURE_OPENAI_ENDPOINT, "
          else
            MISSING_SECRETS="${MISSING_SECRETS}AZURE_AI_ENDPOINT or AZURE_OPENAI_ENDPOINT, "
            CAN_DEPLOY="false"
          fi

          if [ -n "${{ secrets.AZURE_AI_API_KEY }}" ]; then
            PRESENT_SECRETS="${PRESENT_SECRETS}AZURE_AI_API_KEY, "
            CONFIGURED_SECRETS="${CONFIGURED_SECRETS}AZURE_AI_API_KEY, "
          elif [ -n "${{ secrets.AZURE_OPENAI_API_KEY }}" ]; then
            PRESENT_SECRETS="${PRESENT_SECRETS}AZURE_OPENAI_API_KEY, "
            CONFIGURED_SECRETS="${CONFIGURED_SECRETS}AZURE_OPENAI_API_KEY, "
          else
            MISSING_SECRETS="${MISSING_SECRETS}AZURE_AI_API_KEY or AZURE_OPENAI_API_KEY, "
            CAN_DEPLOY="false"
          fi

          # Check required variables
          PRESENT_VARS=""
          MISCONFIG_WARNINGS=""

          echo "ðŸ” Debug: Checking AZURE_FUNCTIONAPP_NAME..."
          echo "  Variable value: '${{ vars.AZURE_FUNCTIONAPP_NAME }}'"
          echo "  Variable is set (boolean): ${{ vars.AZURE_FUNCTIONAPP_NAME != '' }}"
          echo "  Also set as secret (boolean): ${{ secrets.AZURE_FUNCTIONAPP_NAME != '' }}"

          # Check AZURE_FUNCTIONAPP_NAME
          if [ -z "${{ vars.AZURE_FUNCTIONAPP_NAME }}" ]; then
            echo "::error::AZURE_FUNCTIONAPP_NAME is NOT set as a VARIABLE"
            MISSING_VARS="${MISSING_VARS}AZURE_FUNCTIONAPP_NAME, "
            CAN_DEPLOY="false"

            # Check if it was mistakenly set as a secret
            if [ -n "${{ secrets.AZURE_FUNCTIONAPP_NAME }}" ]; then
              echo "::error::AZURE_FUNCTIONAPP_NAME is set as a SECRET but should be a VARIABLE"
              echo "::error::To fix:"
              echo "::error::  1. Go to Settings â†’ Secrets and variables â†’ Actions â†’ Secrets tab"
              echo "::error::  2. Delete the AZURE_FUNCTIONAPP_NAME secret"
              echo "::error::  3. Go to Variables tab â†’ New repository variable"
              echo "::error::  4. Name: AZURE_FUNCTIONAPP_NAME"
              echo "::error::  5. Value: Your function app name (e.g., phoenix-rooivalk-functions)"
              MISCONFIG_WARNINGS="${MISCONFIG_WARNINGS}\n  âš ï¸  AZURE_FUNCTIONAPP_NAME is set as a SECRET but should be a VARIABLE"
              echo "::warning::AZURE_FUNCTIONAPP_NAME is configured as a secret but should be a variable. Delete the secret and set it as a variable instead."
            else
              echo "::error::To fix: Add AZURE_FUNCTIONAPP_NAME as a repository VARIABLE (not secret)"
              echo "::error::  1. Go to Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab"
              echo "::error::  2. Click 'New repository variable'"
              echo "::error::  3. Name: AZURE_FUNCTIONAPP_NAME"
              echo "::error::  4. Value: Your function app name (e.g., phoenix-rooivalk-functions)"
            fi
          else
            echo "âœ… AZURE_FUNCTIONAPP_NAME is configured: ${{ vars.AZURE_FUNCTIONAPP_NAME }}"
            CONFIGURED_VARS="${CONFIGURED_VARS}AZURE_FUNCTIONAPP_NAME, "
            PRESENT_VARS="${PRESENT_VARS}AZURE_FUNCTIONAPP_NAME, "

            # Even if variable exists, warn if it's ALSO set as a secret (duplicate configuration)
            if [ -n "${{ secrets.AZURE_FUNCTIONAPP_NAME }}" ]; then
              MISCONFIG_WARNINGS="${MISCONFIG_WARNINGS}\n  âš ï¸  AZURE_FUNCTIONAPP_NAME exists as both SECRET and VARIABLE - delete the SECRET version"
              echo "::warning::AZURE_FUNCTIONAPP_NAME is set as both a secret and a variable. Delete the secret version to avoid confusion."
            fi
          fi

          # Check AZURE_AI_DEPLOYMENT_NAME
          echo "ðŸ” Debug: Checking AZURE_AI_DEPLOYMENT_NAME..."
          echo "  Variable value: '${{ vars.AZURE_AI_DEPLOYMENT_NAME }}'"
          echo "  Variable is set (boolean): ${{ vars.AZURE_AI_DEPLOYMENT_NAME != '' }}"
          echo "  Also set as secret (boolean): ${{ secrets.AZURE_AI_DEPLOYMENT_NAME != '' }}"

          if [ -n "${{ vars.AZURE_AI_DEPLOYMENT_NAME }}" ]; then
            echo "âœ… AZURE_AI_DEPLOYMENT_NAME is configured: ${{ vars.AZURE_AI_DEPLOYMENT_NAME }}"
            PRESENT_VARS="${PRESENT_VARS}AZURE_AI_DEPLOYMENT_NAME, "
            CONFIGURED_VARS="${CONFIGURED_VARS}AZURE_AI_DEPLOYMENT_NAME, "

            # Warn about unusual deployment names (may indicate typos or configuration errors)
            DEPLOYMENT_NAME="${{ vars.AZURE_AI_DEPLOYMENT_NAME }}"
            if [[ ! "$DEPLOYMENT_NAME" =~ ^(gpt-3|gpt-35|gpt-4|text-embedding|dall-e) ]]; then
              echo "::warning::AZURE_AI_DEPLOYMENT_NAME value '$DEPLOYMENT_NAME' may be unusual"
              echo "::warning::Common Azure OpenAI deployment names start with: gpt-3, gpt-35, gpt-4, text-embedding, dall-e"
              echo "::warning::Verify this matches your Azure OpenAI deployment name exactly"
            fi

            # Warn if it's ALSO set as a secret (duplicate configuration)
            if [ -n "${{ secrets.AZURE_AI_DEPLOYMENT_NAME }}" ]; then
              MISCONFIG_WARNINGS="${MISCONFIG_WARNINGS}\n  âš ï¸  AZURE_AI_DEPLOYMENT_NAME exists as both SECRET and VARIABLE - delete the SECRET version"
              echo "::warning::AZURE_AI_DEPLOYMENT_NAME is set as both a secret and a variable. Delete the secret version to avoid confusion."
            fi
          elif [ -n "${{ vars.AZURE_OPENAI_CHAT_DEPLOYMENT }}" ]; then
            echo "âœ… AZURE_OPENAI_CHAT_DEPLOYMENT is configured: ${{ vars.AZURE_OPENAI_CHAT_DEPLOYMENT }}"
            PRESENT_VARS="${PRESENT_VARS}AZURE_OPENAI_CHAT_DEPLOYMENT, "
            CONFIGURED_VARS="${CONFIGURED_VARS}AZURE_OPENAI_CHAT_DEPLOYMENT, "
          else
            # Check for common typos (specifically the 'v' prefix typo)
            if [ -n "${{ vars.vAZURE_AI_DEPLOYMENT_NAME }}" ]; then
              echo "::error::Variable name typo detected: vAZURE_AI_DEPLOYMENT_NAME should be AZURE_AI_DEPLOYMENT_NAME"
              echo "::error::Found: vAZURE_AI_DEPLOYMENT_NAME (with 'v' prefix)"
              echo "::error::Should be: AZURE_AI_DEPLOYMENT_NAME (without 'v' prefix)"
              echo "::error::To fix:"
              echo "::error::  1. Go to Settings â†’ Secrets and variables â†’ Actions â†’ Variables tab"
              echo "::error::  2. Delete vAZURE_AI_DEPLOYMENT_NAME"
              echo "::error::  3. Create new variable: AZURE_AI_DEPLOYMENT_NAME with value from Azure OpenAI deployment"
              MISSING_VARS="${MISSING_VARS}AZURE_AI_DEPLOYMENT_NAME (found as vAZURE_AI_DEPLOYMENT_NAME), "
              MISCONFIG_WARNINGS="${MISCONFIG_WARNINGS}\n  âš ï¸  Found vAZURE_AI_DEPLOYMENT_NAME but it should be AZURE_AI_DEPLOYMENT_NAME (remove the 'v' prefix)"
              CAN_DEPLOY="false"
            else
              echo "::warning::AZURE_AI_DEPLOYMENT_NAME is not set (will use default 'gpt-4')"
              MISSING_VARS="${MISSING_VARS}AZURE_AI_DEPLOYMENT_NAME, "
              # Warning only - has default in workflow
            fi
          fi

          # Output results
          echo "can_deploy=${CAN_DEPLOY}" >> $GITHUB_OUTPUT
          echo "missing_secrets=${MISSING_SECRETS%%, }" >> $GITHUB_OUTPUT
          echo "present_secrets=${PRESENT_SECRETS%%, }" >> $GITHUB_OUTPUT
          echo "missing_vars=${MISSING_VARS%%, }" >> $GITHUB_OUTPUT
          echo "configured_secrets=${CONFIGURED_SECRETS%%, }" >> $GITHUB_OUTPUT
          echo "configured_vars=${CONFIGURED_VARS%%, }" >> $GITHUB_OUTPUT
          echo "present_vars=${PRESENT_VARS%%, }" >> $GITHUB_OUTPUT

          # Summary
          if [ "$CAN_DEPLOY" = "false" ]; then
            echo "## âŒ Infrastructure Validation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show misconfiguration warnings first if any
            if [ -n "$MISCONFIG_WARNINGS" ]; then
              echo "### âš ï¸ Configuration Issues Detected:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo -e "$MISCONFIG_WARNINGS" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "**Fix these issues:**" >> $GITHUB_STEP_SUMMARY
              echo "1. Delete incorrectly typed secrets/variables in Settings â†’ Secrets and variables â†’ Actions" >> $GITHUB_STEP_SUMMARY
              echo "2. Add them with the correct name and type (Secret vs Variable)" >> $GITHUB_STEP_SUMMARY
              echo '3. See `.github/AZURE_SETUP.md` for the complete list of correct names' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [ -n "$PRESENT_SECRETS" ]; then
              echo "### âœ… Configured Secrets:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${PRESENT_SECRETS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$PRESENT_VARS" ]; then
              echo "### âœ… Configured Variables:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${PRESENT_VARS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$MISSING_SECRETS" ]; then
              echo "### âŒ Missing Secrets:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${MISSING_SECRETS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$MISSING_VARS" ]; then
              echo "### âŒ Missing Variables:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${MISSING_VARS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$CONFIGURED_SECRETS" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âœ… Configured Secrets:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${CONFIGURED_SECRETS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$CONFIGURED_VARS" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### âœ… Configured Variables:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${CONFIGURED_VARS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Required Infrastructure Setup:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. **Azure Function App**: Create in Azure Portal" >> $GITHUB_STEP_SUMMARY
            echo "2. **Cosmos DB**: Create database with containers" >> $GITHUB_STEP_SUMMARY
            echo "3. **Azure OpenAI**: Deploy chat and embedding models" >> $GITHUB_STEP_SUMMARY
            echo "4. **Application Insights**: For monitoring (optional)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“– **Complete Setup Guide**: \`.github/DEPLOYMENT_SEQUENCE.md\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See also:" >> $GITHUB_STEP_SUMMARY
            echo "- \`apps/docs/azure-functions/INFRASTRUCTURE.md\` for Functions setup" >> $GITHUB_STEP_SUMMARY
            echo "- \`.github/AZURE_SETUP.md\` for secrets configuration" >> $GITHUB_STEP_SUMMARY
            echo "- \`infra/azure/README.md\` for infrastructure overview" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Infrastructure Validation Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All required secrets and variables are configured." >> $GITHUB_STEP_SUMMARY
            if [ -n "$CONFIGURED_SECRETS" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Configured Secrets:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${CONFIGURED_SECRETS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$CONFIGURED_VARS" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Configured Variables:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${CONFIGURED_VARS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "$PRESENT_SECRETS" ]; then
              echo "### âœ… Configured Secrets:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${PRESENT_SECRETS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -n "$PRESENT_VARS" ]; then
              echo "### âœ… Configured Variables:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "${PRESENT_VARS%%, }" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Fail if missing infrastructure
        if: steps.check.outputs.can_deploy == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš¨ DEPLOYMENT BLOCKED: Azure Infrastructure Not Yet Configured"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "::error::Missing required infrastructure. See job summary for details."
          echo ""
          echo "âŒ Missing secrets: ${{ steps.check.outputs.missing_secrets }}"
          echo "âŒ Missing variables: ${{ steps.check.outputs.missing_vars }}"
          echo ""
          echo "âœ… Configured secrets: ${{ steps.check.outputs.configured_secrets }}"
          echo "âœ… Configured variables: ${{ steps.check.outputs.configured_vars }}"
          echo ""
          echo "ðŸ“– DEPLOYMENT SEQUENCE: .github/DEPLOYMENT_SEQUENCE.md"
          echo ""
          echo "ðŸš€ RECOMMENDED: Use the automated infrastructure deployment workflow"
          echo ""
          echo "  Option A: GitHub Actions (Automated - RECOMMENDED)"
          echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  1ï¸âƒ£  Go to Actions â†’ 'Deploy Azure Infrastructure'"
          echo "  2ï¸âƒ£  Click 'Run workflow'"
          echo "  3ï¸âƒ£  Select environment (dev/stg/prd) and location"
          echo "  4ï¸âƒ£  Click 'Run workflow' button"
          echo "  5ï¸âƒ£  Wait for infrastructure deployment and secrets configuration"
          echo "  6ï¸âƒ£  Re-run this workflow - it will now succeed!"
          echo ""
          echo "  Option B: Manual CLI (Advanced)"
          echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "  1ï¸âƒ£  Deploy infrastructure:"
          echo "      cd infra/azure && ./scripts/setup-all.sh dev eastus"
          echo ""
          echo "  2ï¸âƒ£  Configure GitHub secrets:"
          echo "      ./infra/azure/output/github-secrets.dev.sh"
          echo ""
          echo "  3ï¸âƒ£  Re-run this workflow"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1

  # ===========================================
  # Build and Test
  # ===========================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: validate-infrastructure
    if:
      always() && (needs.validate-infrastructure.result == 'success' ||
      github.event_name == 'pull_request')
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.6.0

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: TypeScript Build
        run: pnpm run build

      - name: Run Tests
        run: pnpm test || echo "No tests configured yet"
        continue-on-error: true

      - name: Validate Function Configuration
        run: |
          echo "Validating Azure Functions configuration..."

          # Check host.json exists
          if [ ! -f "host.json" ]; then
            echo "::error::host.json not found"
            exit 1
          fi

          # Check local.settings.json.example exists
          if [ ! -f "local.settings.json.example" ]; then
            echo "::warning::local.settings.json.example not found - consider adding for developer onboarding"
          fi

          # Validate required files
          echo "âœ… Configuration files validated"

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: azure-functions-build
          path: |
            ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/dist
            ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/host.json
            ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/package.json
          retention-days: 1

  # ===========================================
  # Deploy to Azure
  # ===========================================
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [validate-infrastructure, build]
    if: |
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch') &&
      needs.validate-infrastructure.outputs.can_deploy == 'true'
    permissions:
      contents: read
      id-token: write # Required for OIDC auth with Azure
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v6
        with:
          name: azure-functions-build
          path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.6.0

      - name: Install production dependencies
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: pnpm install --no-frozen-lockfile --prod

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ vars.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
          respect-funcignore: true
          scm-do-build-during-deployment: true

      - name: Configure App Settings
        if: vars.CONFIGURE_APP_SETTINGS == 'true'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Environment Variables
        if: vars.CONFIGURE_APP_SETTINGS == 'true'
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ vars.AZURE_FUNCTIONAPP_NAME }}
          app-settings-json: |
            [
              { "name": "COSMOS_DB_CONNECTION_STRING", "value": "${{ secrets.COSMOS_DB_CONNECTION_STRING }}", "slotSetting": false },
              { "name": "AZURE_AI_ENDPOINT", "value": "${{ secrets.AZURE_AI_ENDPOINT || secrets.AZURE_OPENAI_ENDPOINT }}", "slotSetting": false },
              { "name": "AZURE_AI_API_KEY", "value": "${{ secrets.AZURE_AI_API_KEY || secrets.AZURE_OPENAI_API_KEY }}", "slotSetting": false },
              { "name": "AZURE_AI_DEPLOYMENT_NAME", "value": "${{ vars.AZURE_AI_DEPLOYMENT_NAME || 'gpt-4' }}", "slotSetting": false },
              { "name": "APPLICATIONINSIGHTS_CONNECTION_STRING", "value": "${{ secrets.APPLICATIONINSIGHTS_CONNECTION_STRING }}", "slotSetting": false },
              { "name": "SENDGRID_API_KEY", "value": "${{ secrets.SENDGRID_API_KEY }}", "slotSetting": false },
              { "name": "AZURE_NOTIFICATION_HUB_CONNECTION_STRING", "value": "${{ secrets.AZURE_NOTIFICATION_HUB_CONNECTION_STRING }}", "slotSetting": false },
              { "name": "GITHUB_TOKEN", "value": "${{ secrets.GITHUB_TOKEN }}", "slotSetting": false },
              { "name": "ADMIN_NOTIFICATION_EMAIL", "value": "${{ vars.ADMIN_NOTIFICATION_EMAIL }}", "slotSetting": false },
              { "name": "DOCS_BASE_URL", "value": "${{ vars.DOCS_BASE_URL }}", "slotSetting": false },
              { "name": "WEEKLY_REPORT_REPOS", "value": "${{ vars.WEEKLY_REPORT_REPOS || 'JustAGhosT/PhoenixRooivalk' }}", "slotSetting": false }
            ]

      - name: Verify Deployment
        run: |
          echo "Verifying deployment..."
          HEALTH_URL="https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health"
          STATUS="000"  # Initialize to failure state

          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Health check passed"
              break
            fi
            echo "Attempt $i: Status $STATUS, retrying in 10s..."
            sleep 10
          done

          if [ "$STATUS" != "200" ]; then
            echo "::warning::Health check failed after deployment. Status: $STATUS"
          fi

      - name: Deployment Summary
        run: |
          echo "## âœ… Azure Functions Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Function App**: \`${{ vars.AZURE_FUNCTIONAPP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints:" >> $GITHUB_STEP_SUMMARY
          echo "- Health: https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health" >> $GITHUB_STEP_SUMMARY
          echo "- News: https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/news" >> $GITHUB_STEP_SUMMARY
          echo "- AI: https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/ai" >> $GITHUB_STEP_SUMMARY
          echo "- Weekly Reports: https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/reports/weekly" >> $GITHUB_STEP_SUMMARY
          echo "- Access Applications: https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/access/applications" >> $GITHUB_STEP_SUMMARY
          echo "- Known Emails: https://${{ vars.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/known-emails" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scheduled Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- fetchNewsScheduled (every 6 hours)" >> $GITHUB_STEP_SUMMARY
          echo "- processEmailQueueScheduled (every 5 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "- sendDailyDigestScheduled (daily 8 AM UTC)" >> $GITHUB_STEP_SUMMARY
          echo "- cacheCleanupScheduled (hourly)" >> $GITHUB_STEP_SUMMARY
          echo "- generateWeeklyReportScheduled (Mondays 9 AM UTC)" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # PR Validation (no deployment)
  # ===========================================
  pr-check:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
    defaults:
      run:
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.6.0

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: TypeScript Build
        run: pnpm run build

      - name: Run Tests
        run: pnpm test || echo "Tests not configured"
        continue-on-error: true

      - name: Check for Infrastructure Documentation
        run: |
          if [ ! -f "INFRASTRUCTURE.md" ]; then
            echo "::warning::INFRASTRUCTURE.md not found - consider adding setup documentation"
          fi

      - name: PR Summary
        run: |
          echo "## âœ… Azure Functions PR Check Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript compilation: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration validation: âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Functions will be deployed when merged to main." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required Infrastructure for Deployment:" >> $GITHUB_STEP_SUMMARY
          echo "- Azure Function App" >> $GITHUB_STEP_SUMMARY
          echo "- Cosmos DB" >> $GITHUB_STEP_SUMMARY
          echo "- Azure OpenAI" >> $GITHUB_STEP_SUMMARY
          echo "- Application Insights (optional)" >> $GITHUB_STEP_SUMMARY
